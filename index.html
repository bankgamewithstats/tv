<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f1e4a" />
  <title>Bank Game — Live Leaderboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Idle/waiting state -->
  <div id="waiting-screen" class="screen">
    <div class="logo-corner">
      <img src="logo.png" alt="Bank" class="logo-img" />
    </div>
    <div class="waiting-content">
      <div class="waiting-title">Bank Game with Stats</div>
      <div class="waiting-subtitle">Waiting for game...</div>
    </div>
  </div>

  <!-- Live leaderboard -->
  <div id="game-screen" class="screen hidden">
    <div class="logo-corner">
      <img src="logo.png" alt="Bank" class="logo-img" />
    </div>
    <header class="game-header">
      <div class="round-display" id="round-display">Round 1 / 10</div>
      <div class="pot-display">
        <span class="pot-label">POT</span>
        <span class="pot-value" id="pot-value">0</span>
      </div>
    </header>
    <main class="leaderboard" id="players-list"></main>
  </div>

  <!-- Google Cast Receiver SDK — no-op in non-Cast browsers -->
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <script>
    // Initialize Cast receiver if running inside Chromecast
    if (window.cast && cast.framework) {
      const context = cast.framework.CastReceiverContext.getInstance();
      const options = new cast.framework.CastReceiverOptions();
      // CRITICAL: disableIdleTimeout prevents receiver closing mid-game
      // (default: Cast closes after ~5 min with no media activity)
      options.disableIdleTimeout = true;
      context.start(options);
    }
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

    // Firebase config — security via rules, not key secrecy (standard Firebase practice)
    const firebaseConfig = {
      apiKey: "AIzaSyDkqm3qDC50wcvNOtdL7X2ocKImMpFTYR0",
      authDomain: "bank-game-with-stats.firebaseapp.com",
      databaseURL: "https://bank-game-with-stats-default-rtdb.firebaseio.com",
      projectId: "bank-game-with-stats",
      storageBucket: "bank-game-with-stats.appspot.com",
      messagingSenderId: "333591070423",
      appId: "1:333591070423:web:ab922405955584dfb39292"
    };

    const code = new URLSearchParams(window.location.search).get('code');

    const waitingScreen = document.getElementById('waiting-screen');
    const gameScreen = document.getElementById('game-screen');
    const roundDisplay = document.getElementById('round-display');
    const potValue = document.getElementById('pot-value');
    const playersList = document.getElementById('players-list');

    function showWaiting() {
      waitingScreen.classList.remove('hidden');
      gameScreen.classList.add('hidden');
    }

    function showGame() {
      waitingScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
    }

    function formatScore(n) {
      return n.toLocaleString();
    }

    // Track previous isBanked state per player id for flash animation detection
    const prevBankedState = {};

    function renderLeaderboard(state) {
      // Show game screen
      showGame();

      // Round display
      roundDisplay.textContent = `Round ${state.currentRound} / ${state.totalRounds}`;

      // Pot display
      potValue.textContent = formatScore(state.pot);

      // Sort players by score descending
      const sorted = [...state.players].sort((a, b) => b.score - a.score);

      playersList.innerHTML = sorted.map((player, idx) => {
        const isCurrentPlayer = state.players[state.currentPlayerIndex]?.id === player.id && !player.isBanked;
        const justBanked = !prevBankedState[player.id] && player.isBanked;

        let rowClass = 'player-row';
        if (player.isBanked) rowClass += ' banked';
        if (isCurrentPlayer) rowClass += ' current';
        if (justBanked) rowClass += ' just-banked';

        const lockIcon = player.isBanked ? '<span class="lock-icon">&#x1F512;</span>' : '';
        const currentArrow = isCurrentPlayer ? '<span class="current-arrow">&#x25B6;</span>' : '';
        const rank = idx + 1;

        return `
          <div class="${rowClass}" data-id="${player.id}">
            <span class="rank">${rank}</span>
            <span class="player-name">${escapeHtml(player.name)} ${lockIcon}</span>
            <span class="player-score">${formatScore(player.score)} ${currentArrow}</span>
          </div>
        `;
      }).join('');

      // Update previous banked state tracking
      state.players.forEach(p => {
        prevBankedState[p.id] = p.isBanked;
      });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    if (!code) {
      showWaiting();
    } else {
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      onValue(ref(db, `rooms/${code}`), (snapshot) => {
        const data = snapshot.val();
        if (!data || data.gamePhase === 'setup') {
          showWaiting();
        } else {
          renderLeaderboard(data);
        }
      });
    }
  </script>
</body>
</html>
